<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.16: http://docutils.sourceforge.net/" />
<title>TRUBA'da MATLAB Kullanımı</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7952 2016-07-26 18:15:59Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

.subscript {
  vertical-align: sub;
  font-size: smaller }

.superscript {
  vertical-align: super;
  font-size: smaller }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left, table.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right, table.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

table.align-center {
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

.align-top    {
  vertical-align: top }

.align-middle {
  vertical-align: middle }

.align-bottom {
  vertical-align: bottom }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="truba-da-matlab-kullanimi">
<h1 class="title">TRUBA'da MATLAB Kullanımı</h1>

<p>TRUBA üzerinde MATLAB çalıştırmak isteyen kullanıcıların <strong>kendilerine ait bir lisansa</strong> sahip olması gerekmektedir. Bu lisans <strong>kişisel, akademik ya da floating (kayar) lisans</strong> olabilir.</p>
<p>Lisans türleri hakkında bilgiye <a class="reference external" href="https://www.mathworks.com/pricing-licensing.html">https://www.mathworks.com/pricing-licensing.html</a> adresinden erişebilirsiniz. Ayrıca üniversitelerin bilgi işlem merkezlerinden de lisansınız hakkında detaylı bilgi edinebilirsiniz.</p>
<p>MATLAB, sahip olunan lisans türüne göre TRUBA üzerinde farklı şekillerde çalıştırılabilir.</p>
<div class="section" id="akademik-tah-total-academic-headcount-lisansi-olan-kullanicilar">
<h1>Akademik (TAH: Total Academic Headcount) Lisansı Olan Kullanıcılar</h1>
<p>EGI ile MATHWORKS arasındaki anlaşma sayesinde kullanıcılar, <strong>kişisel lisansları</strong> ile EGI üyesi ülkelerin süperbilgisayar merkezlerinde MATLAB çalıştırabilmektedirler. Akademik lisansınızın Mathworks üzerinden doğrulanabilmesi için grafik ekrana ihtiyaç duyulmaktadır. Bu lisansa sahip olarak TRUBA üzerinde MATLAB çalıştıracaksanız birkaç metot bulunmaktadır.</p>
<ul>
<li><p class="first"><strong>Kişisel bilgisayarınızda MATLAB çalıştırarak</strong></p>
</li>
<li><p class="first">TRUBA üzerindeki kullanıcı arayüz sunucularından <a href="#id1"><span class="problematic" id="id2">:ref:`grafik-ekran`</span></a> alarak</p>
<div class="system-message" id="id1">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 19); <em><a href="#id2">backlink</a></em></p>
<p>Unknown interpreted text role &quot;ref&quot;.</p>
</div>
</li>
</ul>
<div class="section" id="kisisel-bilgisayarinizda-matlab-calistirirak-truba-ya-is-gondermek">
<h2>Kişisel Bilgisayarınızda MATLAB Çalıştırırak TRUBA'ya İş Göndermek</h2>
<ul>
<li><p class="first">MATLAB'ın güncel versiyonunu <a class="reference external" href="https://www.mathworks.com/downloads/">Mathworks</a> sitesinden indirebilirsiniz. Akademik lisansa sahipseniz, kullanıcı adı ve şifrenizle giriş yapıp MATLAB'ı indirebilir ve kişisel bilgisayarınıza kurulumu gerçekleştirebilirsiniz.</p>
</li>
<li><p class="first">Kişisel bilgisayarınızdan çalıştırdığınız MATLAB ile TRUBA’ya iş gönderebilmek için bir seferlik küme ayarının (“parallel cluster”) yapılması gerekmektedir.</p>
</li>
<li><p class="first">İlgili ayar dosyaları <tt class="docutils literal">/truba/sw/scripts/matlab/matlabScripts/truba.nonshared.R2021b</tt> klasöründe yer almaktadır. Buradan ilgili klasörü kendi bilgisayarınıza indirebilirsiniz.</p>
<pre class="literal-block">
scp -r username&#64;levrek1.ulakbim.gov.tr:/truba/sw/scripts/matlab/matlabScripts/truba.nonshared.R2021b ~/TRUBA_R2021b
</pre>
</li>
</ul>
<p>İlgili dosyayı ayrıca <a href="#id3"><span class="problematic" id="id4">:download:`bu web bağlantisindan &lt;/assets/matlab-howto/config-files/truba.nonshared.R2021b.zip&gt;`_</span></a> indirebilirsiniz.</p>
<div class="system-message" id="id3">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 34); <em><a href="#id4">backlink</a></em></p>
Mismatch: both interpreted text role prefix and reference suffix.</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>TRUBA üzerinde MATLAB R2021b versiyonu yüklüdür. Bu yöntem ile çalışmak istiyorsanız siz de kendi bilgisayarınıza aynı versiyonu yüklemeniz gerekmektedir.</li>
<li>Aşağıdaki örnek ilgili klasörün <tt class="docutils literal"><span class="pre">'~/TRUBA_R2021b'</span></tt> altında olduğu varsayılarak düzenlenmiştir.)</li>
</ul>
</div>
<ul class="simple">
<li>Kişisel bilgisayarınızda çalıştırdığınız <strong>MATLAB komut penceresinden</strong> indirmiş olduğunuz ayar dosyasına gidip, <tt class="docutils literal">configCluster</tt> komutunu çalıştırınız. Sonrasında TRUBA kullanıcı adınızı giriniz.</li>
</ul>
<pre class="literal-block">
&gt;&gt; cd ~/TRUBA_R2021b/
&gt;&gt; configCluster
</pre>
<img alt="/assets/matlab-howto/matlab3.png" src="/assets/matlab-howto/matlab3.png" style="width: 400px;" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal">configCluster</tt> komutunu çalıştırdığınızda varsayılan kümeniz TRUBA olarak ayarlanacaktır. Eğer lokal makinenizde iş çalıştıracaksanız
<tt class="docutils literal"><span class="pre">c=parcluster('local');</span></tt>
şeklinde ilgili ayarı değiştirmeniz gerekecektir.</p>
</div>
<p>Bu işlemi bir kez gerçekleştirmek yeterlidir. Bundan sonra iş gönderirken çalıştıracağınız işin ihtiyacına göre ilgili iş parametrelerinin belirtilmesi yeterli olacaktır. Aşağıda bir örnek verilmiştir.</p>
<div class="section" id="hesap-ve-kuyruk-parametrelerinin-yapilandirmasi">
<span id="matlab-truba-config"></span><h3>Hesap ve kuyruk parametrelerinin yapılandırması</h3>
<p>MATLAB’ı çalıştıracağınız küme hakkındaki parametrelerinizi ayarlamanız gerekmektedir. &quot;<strong>truba.nonshared.R2021b</strong>&quot; dizini içerisindeki <strong>truba.m</strong> dosyası parametreleri otomatik olarak yapılandırmaktadır.  <strong>MATLAB komut satırından</strong> <code>truba</code> komutunun çalıştırılması yeterlidir.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Eğer kampüs dışından (ULAKNET ağı dışından) bağlanıyorsanız öncelikle <a href="#id5"><span class="problematic" id="id6">:ref:`open-vpn`</span></a> ile bağlantı yapmanız gerekmektedir.</p>
<div class="last system-message" id="id5">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 70); <em><a href="#id6">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
</div>
<pre class="literal-block">
% kümeyi oluşturun
c=parcluster;

% bağlanacağınız arayüz makinesinin ip adresini
%VPN ile bağlanıyorsanız 172.16.7.1 , ULAKNET üzerinden bağlanıyorsanız  levrek1.ulakbim.gov.tr
c.AdditionalProperties.ClusterHost='172.16.7.1';

% ssh portunu ayarlayın
c.AdditionalProperties.UseSshPort=22;

% işinizi göndereceğiniz kuyruğun adını yazın
c.AdditionalProperties.QueueName='hamsi';

% işinizin süreceği maksimum zamanı girin. Aksilik yaşamamanız için tahmin ettiğiniz sürenin %20 fazlasını belirtin.
c.AdditionalProperties.WallTime='3:00:00';

% Node sayısını belirtin. (Genelde çalıştırılan işler için bir node yeterlidir)
c.AdditionalProperties.Nodes=1

% Thread sayısını giriniz. (--cpu-per-task)
c.NumThreads=28;

% işinizi kuyruğa göndermeden önce konfigürasyonunuzu tekrar gözden geçirebilirsiniz.
c.AdditionalProperties

% yapmış olduğunuz değişikliklerin farklı MATLAB oturumlarında kayıtlı kalmasını istiyorsanız yapmış olduğunuz değişiklikleri profilinize kaydedin.
c.saveProfile
</pre>
<img alt="/assets/matlab-howto/matlab4.png" src="/assets/matlab-howto/matlab4.png" style="width: 400px;" />
<p>Küme ayarlarınız başarıyla oluşturulmuş durumda. Ayrıca <tt class="docutils literal"><span class="pre">&quot;Home-&gt;Parallel-&gt;</span> Create and Manage Clusters&quot;</tt> sekmesi altından oluşturmuş olduğunuz kümenin özelliklerini görebilirsiniz. MATLAB'ı kapatıp açsanız da oluşturmuş olduğunuz küme ayarlarınız kayıtlı halde duracaktır. Buradan &quot;default profile&quot; seçimini de gerçekleştirebilirsiniz.</p>
<p>İşlerinizi gönderirken arayüz üzerinden de bu ayarları değiştirebilirsiniz.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">TRUBA üzerinde kurulu MATLAB, sadece  CentOS-7.9 işletim sistemi ile çalışmaktadır. Bu nedenle işler sadece <strong>hamsi</strong> kümesine gönderilebilir.</p>
</div>
<img alt="/assets/matlab-howto/matlab6.png" src="/assets/matlab-howto/matlab6.png" style="width: 400px;" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Küme üzerinde İşlerinizin kayıt edildiği yer varsayılan olarak <tt class="docutils literal">.matlab/3p_cluster_jobs/truba/TRUBA.R2021b/nonshared</tt> klasörüdür.  İşinizin durumunu ve sonuçlarını buradan kontrol edebilirsiniz.</p>
<p class="last"><code>c.AdditionalProperties.RemoteJobStorageLocation=</code> komutu ile de ilgili klasörün yerini de değiştirebilirsiniz.</p>
</div>
<p>Herhangi bir parametreyi silmek istediğinizde (örneğin e-posta adresi) değişkeni boş bırakmanız yeterlidir.</p>
<pre class="literal-block">
c.AdditionalProperties.EmailAddress = ''
</pre>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Slurm Parametresi</th>
<th class="head">MATLAB Karşılığı</th>
<th class="head">Açıklama</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><code>--nodes, -N</code></td>
<td><code>c.AdditionalProperties.Nodes</code></td>
<td>&nbsp;</td>
</tr>
<tr><td><code>--ntasks, -n</code></td>
<td><code>pool=</code></td>
<td>en fazla c.NumWorkers  kadar olabilir. Herhangi bir değer verilmezse c.NumWorkers değeri kullanılır.</td>
</tr>
<tr><td><code>--cpus-per-task, -c</code></td>
<td><code>c.NumThreads</code></td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Hamsi</strong> kuyruğunda sunucu başına minimum 28 çekirdek kullanılabilir. Hamsi kuyruğuna gönderilecek işler 28  ve katlarında çekirdek kullanmalıdır.</p>
</div>
<p>MATLAB komut satırından çalıştıracağınız tüm komutlar  kişisel bilgisayarınzda çalışacaktır. İşlem gücü gereken  fonksiyon ya da dosyaları TRUBA üzerinde çalıştırmak için ilgili kod parçasını <code>batch</code> komutu ile kuyruğa göndermeniz gerekecektir. Aşağıdaki örnekleri inceleyebilirsiniz. Detaylı bilgi için <a class="reference external" href="https://www.mathworks.com/help/parallel-computing/batch.html">buradan</a> bilgi edinebilirsiniz.</p>
</div>
<div class="section" id="ornek-1-dahili-komutlar-ya-da-fonksiyonlar">
<h3>Örnek 1: Dahili komutlar ya da fonksiyonlar</h3>
<p>Bu örnekte dahili <code>pwd</code> komutu/fonksiyonu kuyruk üzerinde çalıştırılacaktır.</p>
<pre class="literal-block">
j=batch(c,&#64;pwd,1,{},'CurrentFolder', '.','AutoAddClientPath',false)
</pre>
<p>İşinizi gönderdiğinizde, şekilde görüldüğü gibi TRUBA şifrenizin girilmesi istenecektir. Bu sorgu ekranı gelmiyorsa yukarıdaki küme ayarlarınızı kontrol ediniz. Ayrıca <tt class="docutils literal">batch</tt> komutunun nasıl kullanılacağı ve ilgili parametrelerin ne olduğu hakkında bilgiye <a class="reference external" href="https://www.mathworks.com/help/parallel-computing/batch.html#d123e38009">MATLAB yardım merkezinden</a> erişim sağlayabilirsiniz.</p>
<img alt="/assets/matlab-howto/matlab7.png" src="/assets/matlab-howto/matlab7.png" style="width: 400px;" />
<p>İşinizi gönderdiğinizde bir &quot;Slurm Jobid&quot; si atanacaktır. Ayrica levrek1 arayüzünden <code>squeue</code> komutu ile de işinizin durumunu öğrenebilirsiniz.</p>
<img alt="/assets/matlab-howto/matlab8.png" src="/assets/matlab-howto/matlab8.png" style="width: 400px;" />
<img alt="/assets/matlab-howto/matlab9.png" src="/assets/matlab-howto/matlab9.png" style="width: 400px;" />
<p>MATLAB komut penceresi üzerinden işinizin durumu hakkında bilgi edinebilirsiniz.</p>
<pre class="literal-block">
% işinizin durumu hakkındaki bilgi için:
j.State

% işiniz sonucunu çağırmadan önce bitmesini beklemek için:
j.wait

% iş bittiğinde sonucu görmek için:
j.fetchOutputs

% işiniz artık gerekli değilse işinizi silmek için:
j.delete

% eğer var olan tüm işleri silmek isterseniz
delete(c.Jobs)
</pre>
<p>İşinizin durumunu ayrıca &quot;<strong>MATLAB Job Monitor Tool</strong>&quot; ile de görebilirsiniz. İşinizle ilgili sonucu bu arayüz aracılığıyla da çekebilirsiniz.</p>
<img alt="/assets/matlab-howto/matlab5.png" src="/assets/matlab-howto/matlab5.png" style="width: 400px;" />
<img alt="/assets/matlab-howto/matlab10.png" src="/assets/matlab-howto/matlab10.png" style="width: 400px;" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">İşinizi kuyruğa gönderdikten sonra oturumunuzu açık tutmanıza gerek yoktur. İşiniz tamamlandığında MATLAB'ı tekrar çalıştırıp biten işlerinizin durumunu görebilir ve sonuçlarınızı çağırabilirsiniz. Bu işlemi &quot;MATLAB Job Monitor Tool&quot; ile yapabileceğiniz gibi komut satırından da gerçekleştirebilirsiniz.</p>
</div>
<pre class="literal-block">
c=parcluster;
jobs=c.Jobs

%% ID numarası 2 olan işi seç
 j2 = c.Jobs(2)
 j2.fetchOutputs
</pre>
<img alt="/assets/matlab-howto/matlab11.png" src="/assets/matlab-howto/matlab11.png" style="width: 400px;" />
</div>
<div class="section" id="ornek-2-m-dosyalari">
<h3>Örnek 2: *.m dosyaları</h3>
<p>Dahili komutlar ve fonksiyonların yanı sıra MATLAB betik dosyalarını da (*.m) kuyrukta çalıştırmanız mümkündür.</p>
<pre class="literal-block">
%% test2.m içerigi
pwd
    ls -al
    a = 5; b = 7
    g = a + b
    d = g + sin(b)
    e = 5 * d
    f = exp(-d)
</pre>
<p>Bu dosyayı aşağıdaki komutla kuyruğa gönderebilirsiniz:</p>
<pre class="literal-block">
j=batch('test2','CurrentFolder','/truba/home/kullanici_calisma_dizini/', 'AutoAddClientPath',false);
</pre>
<p>Bu dosya kuyrukta çalışıp sonlandıktan sonra, ekran çıktılarını</p>
<pre class="literal-block">
diary(j)
</pre>
<p>komutu ile alabilirsiniz. Ayrıca dosya içerisinde kullanılan değişkenlerin son değerlerini,</p>
<pre class="literal-block">
load(j)
</pre>
<p>lokal arayüzünüze alabilirsiniz.</p>
</div>
<div class="section" id="ornek-3-lokal-dosyadan-veri-okumak-ve-sonuclari-merkezi-dizinde-dosyaya-yazmak">
<h3>Örnek 3: Lokal dosyadan veri okumak ve sonuçları merkezi dizinde dosyaya yazmak</h3>
<p>Aşağıdaki örnekte kuyruğa göndereceğimiz betik, lokal dizinimizdeki veriyi okuyup işleyecek ve sonucu merkezi dizine yazacaktır.</p>
<pre class="literal-block">
% test3.m içerigi
    pwd
    fileID = fopen('input.txt','r');
    formatSpec = '%d %f';
    sizeA = [2 Inf];
    A = fscanf(fileID,formatSpec,sizeA)
    A
    fclose(fileID);
    x = 1:1:5;
    y = [x;rand(1,5)];
    fileID = fopen('output.txt','w');
    fprintf(fileID,'%d %4.4f\n',y);
    fclose(fileID);
</pre>
<p>Bu dosya kuyruğa aşağıdaki komutla gönderilir.</p>
<pre class="literal-block">
j=batch('test3','CurrentFolder','/truba/home/kullanici_calisma_dizini/', 'AutoAddClientPath',false);
</pre>
<p>Bu dosya kuyrukta çalışıp sonlandıktan sonra, ekran çıktılarını</p>
<pre class="literal-block">
diary(j)
</pre>
<p>komutu ile alabilirsiniz. Ayrıca dosya içerisinde kullanılan değişkenlerin son değerlerini,</p>
<pre class="literal-block">
load(j)
</pre>
<p>lokal arayüzünüze alabilirsiniz.</p>
</div>
<div class="section" id="ornek-4-paralel-is-calistirma-paralel-for-mpi">
<h3>Örnek 4: Paralel iş çalıştırma (paralel for, MPI)</h3>
<p>MATLAB'ın neredeyse tüm fonksiyonları node için paralelleştirmeyi (OpenMP) hali hazırda desteklemektedir. Bu desteği kullanmak için kodda ekstra değişiklikler yapmaya gerek bulunmamaktadır. Herhangi bir MATLAB  fonksiyonu çalıştırıldığında, kod sunucuda izin verilen tüm çekirdekleri kullanacaktır.</p>
<p>MATLAB aynı zamanda nodelar arası paralelleştirmeyi (MPI) de desteklemektedir. Büyük <code>for</code> döngüleri ya da destekeleyen diğer fonksiyonlar, birkaç basit  değişiklikle nodelar arası  paralel çalışır hale getirilebilir. Aşağıdaki kod parçasında paralel for döngüsü kullanılmıştır.</p>
<pre class="literal-block">
%% test4.m dosyasinin icerigi
    function t = parallel_example(iter)
    if nargin==0, iter = 16; end
    disp('Start sim')

    t0 = tic;
    parfor idx = 1:iter
            A(idx) = idx;
            pause(2)
    end
    t = toc(t0);

    disp('Sim completed.')
</pre>
<p>Kodu kuyruğa göndermek için</p>
<pre class="literal-block">
c.NumWorkers=4;
c.NumThreads=7;
j = batch(c,&#64;test4, 1, {}, 'pool',3,'CurrentFolder', '.','AutoAddClientPath',false)
</pre>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>işinizi gönderdiğinizde config ayarlarınıza göre aşağıdaki gibi bir çıktı göreceksiniz.
<tt class="docutils literal">additionalSubmitArgs = <span class="pre">'--ntasks=4</span> <span class="pre">--cpus-per-task=7</span> <span class="pre">-p</span> hamsi <span class="pre">-t</span> 3:00:00 <span class="pre">-N</span> 1 '</tt></p>
<p class="last">pool sayisi <code>--ntask</code> parametresine karşılık gelmektedir. Bir çekirdek işi orkestra eden olarak ayrıldığından pool sayısı <tt class="docutils literal"><span class="pre">&quot;ntasks-1&quot;</span></tt> şeklinde girilmelidir.</p>
</div>
</div>
</div>
<div class="section" id="barbun1-ya-da-sardalya1-uzerinde-matlab-calistirarak-truba-ya-is-gondermek">
<h2>Barbun1 ya da Sardalya1 üzerinde MATLAB çalıştırarak TRUBA'ya iş göndermek</h2>
<p>Öncelikle kişisel lisansınızın TRUBA üzerinde aktif edilmesi gerekmektedir. Lisansınızı aktifleştirmek için <strong>barbun1</strong> ya da <strong>sardalya1</strong> bir sunucularından herhangi birine  grafik arayüzü desteği ile bağlanmak gereklidir. TRUBA kullanıcı arayüzlerine 3 farklı şekilde grafik arayüzü bağlantısı yapılabilir.</p>
<ol class="arabic">
<li><p class="first"><tt class="docutils literal">ssh <span class="pre">-XY</span> username&#64;sunucu_adi</tt> komutu aracılığıyla <a href="#id7"><span class="problematic" id="id8">:ref:`grafik arayüz &lt;grafik-ekran&gt;`</span></a> alarak</p>
<div class="system-message" id="id7">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 347); <em><a href="#id8">backlink</a></em></p>
<p>Unknown interpreted text role &quot;ref&quot;.</p>
</div>
</li>
<li><p class="first"><a href="#id9"><span class="problematic" id="id10">:ref:`VNC ile (barbun1 ve sardalya1) üzerinde (Linux XFCE Desktop) masaüstü çalıştırarak &lt;TRUBA-vnc&gt;`</span></a></p>
<div class="system-message" id="id9">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 349); <em><a href="#id10">backlink</a></em></p>
<p>Unknown interpreted text role &quot;ref&quot;.</p>
</div>
</li>
<li><p class="first"><a href="#id11"><span class="problematic" id="id12">:ref:`OpenOnDemand &lt;open_ondemand&gt;`</span></a> ile bağlanarak. “Interactive Apps” sekmesinden <tt class="docutils literal">“TRUBA Desktop”</tt> <strong>(Linux XFCE Desktop)</strong> oturumu başlatılabilir. Linux Masaüstü üzerinde çalıştırılacak uygulamalar, küme üzerindeki hesaplama sunucularında çalıştırılmış olacaktır. Linux Masaüstünde <strong>terminal</strong> uygulamasından verilecek komutlarla sunucu üzerinde MATLAB da dahil olmak üzere herhangi bir görsel uygulama çalıştırılabilir.</p>
<div class="system-message" id="id11">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 351); <em><a href="#id12">backlink</a></em></p>
<p>Unknown interpreted text role &quot;ref&quot;.</p>
</div>
</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Not: VNC ile grafik arayüzü alarak MATLAB çalıştırmak sadece <tt class="docutils literal">sardalya1</tt> ve <tt class="docutils literal">barbun1</tt> sunucuları için geçerlidir.</p>
</div>
<p><a href="#id13"><span class="problematic" id="id14">:ref:`Buradan &lt;grafik-ekran&gt;`</span></a> grafik arayüzüne nasıl bağlanılacağı hakkında detaylı bilgi edinebilirsiniz.</p>
<div class="system-message" id="id13">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 358); <em><a href="#id14">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
<p>Arayüz sunucusunda terminal ekranı aldıktan sonra MATLAB ile küme profili oluşturmaya başlayabiliriz.</p>
<pre class="literal-block">
# Sistemde yüklü MATLAB versiyonlarını görmek için
module avail -t 2&gt;&amp;1 | grep -i matlab
</pre>
<img alt="/assets/matlab-howto/matlab12.png" src="/assets/matlab-howto/matlab12.png" style="width: 400px;" />
<p>Sistem üzerinde farklı versiyonlar yüklü olabilir (R2018b ve R2021b vb).
Örnek olarak R2021b versiyonunu kullanacaksanız öncelikle bu yazılımı <tt class="docutils literal">module load</tt> ile sisteminize yüklemeniz gerekecektir. Modül kullanımı ile ilgili bigiye <a href="#id15"><span class="problematic" id="id16">:ref:`moduller-truba`</span></a> sayfasından erişebilirsiniz.</p>
<div class="system-message" id="id15">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 370); <em><a href="#id16">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
<pre class="literal-block">
## sisteminizde eskiden yüklü modüllerinizin çakışmamsi için öncelikle yüklü modülleri temizleyin
module purge

## modülü yüklemek için
module load centos7.9/app/matlab/r2021b

## modülün doğru şekilde yüklendiğini doğrulamak için
module list

## MATLAB'i calistirmak icin
matlab -nosplash
</pre>
<p>MATLAB'ı ilk kez çalıştırdığınızda aşağıdaki gibi bir sorgu ekranı açılacak ve lisansınızı aktive etmeniz istenecektir.</p>
<img alt="/assets/matlab-howto/matlab2.png" src="/assets/matlab-howto/matlab2.png" style="width: 400px;" />
<p>Eğer ilgili sorgu ekran otomatik olarak açılmazsa <tt class="docutils literal">matlab/bin</tt> dizinin altinda yer alan <tt class="docutils literal">activate_matlab.sh</tt> betiğini çalıştırarak da aktivasyonu gerçekleştirebilirsiniz.</p>
<pre class="literal-block">
## matlab lisansını aktive etmek için
/truba/sw/centos7.9/app/matlab/r2021b/bin/activate_matlab.sh
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Not: Daha önce sunucu üzerinde lisansınızı kayıt ettirmişseniz kaydın yeniden yapılmasına gerek olmayabilir. Lisans uyarısı aldığınız taktirde ise
<tt class="docutils literal">activate</tt> betiğini yeniden çalıştırınız.</p>
</div>
<p>Lisans doğrulamasını gerçekleştirdikten sonra Matlab'ı yeniden çalıştırarak slurm küme ayarlarını gerçekleştirebilirsiniz.</p>
<pre class="literal-block">
matlab -nosplash
</pre>
<p>Öncelikle ayar dosyasını (<tt class="docutils literal">/truba/sw/scripts/matlab/matlabScripts/truba.shared.R2021b</tt>) arayüz sunucusunda kendi dizininize kopyalayın.</p>
<pre class="literal-block">
## bagli oldugunuz arayuz sunucusunda (ornegin levrek1)
cp -r /truba/sw/scripts/matlab/matlabScripts/truba.shared.R2021b ~/TRUBA_2021b_shared
</pre>
<p>Daha sonra <strong>MATLAB Komut Satırından</strong> ilgili ayar dosyası çalıştırılır.</p>
<pre class="literal-block">
matlab -nosplash
cd ~/TRUBA_2021b_shared
configCluster
</pre>
<p>Bu ayar dosyasını bir kez çalıştırmanız yeterlidir. Daha sonra <a href="#id17"><span class="problematic" id="id18">:ref:`MATLAB-TRUBA_config`</span></a> yönergelerini takip ederek hesaplama kümelerine iş gönderebilirsiniz.</p>
<div class="system-message" id="id17">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 426); <em><a href="#id18">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Kişisel bilgisayar üzerinden çalıştırdığınız MATLAB ile TRUBA kümesine iş göndermek için <tt class="docutils literal">/truba/sw/scripts/matlab/matlabScripts/truba.nonshared.R2021b</tt> ayar dosyasını,</p>
<p class="last">TRUBA arayüz sunucularında grafik ekran alarak çalıştırdığınız MATLAB ile kümeye iş gönderecekseniz ise <tt class="docutils literal">/truba/sw/scripts/matlab/matlabScripts/truba.shared.R2021b ~/TRUBA_2021b_shared</tt> ayar dosyasını kullanmanız gerekecektir. Aksi takdirde işlerinizde hata ile karşılaşacaksınız.</p>
</div>
</div>
</div>
<div class="section" id="kayar-floating-lisansi-olan-kullanicilar">
<h1>Kayar (Floating) Lisansı Olan Kullanıcılar</h1>
<p>Lisans doğrulaması, kullanıcının kendi kurumundaki lisans sunucusu tarafından yapılır. Bu nedenle kurumdaki lisans sunucusunun TRUBA sunucularına lisans doğrulaması için erişim izni vermesi gereklidir. TRUBA'nın çıkış IP adresi <strong>193.140.99.241</strong>'dir. Bu yetki ile ilgili kurumunuzun bilgi işlem daire başkanlığıyla iletişime geçiniz.</p>
<p>Kayar lisansına sahipseniz bir slurm betik dosyası hazırlayarak, işlerinizi <tt class="docutils literal">sbatch</tt> komutu ile iş kuyruğuna gönderebilirsiniz.</p>
<p>TRUBA üzerinde halihazırda bazı MATLAB versiyonları yüklü durumdadır. Bu yazılımlar zaman içerisinde yeni versiyonlar eklendikçe güncellenmektedir</p>
<p>Sistemde yüklü yazılımları <tt class="docutils literal">module available</tt> komutu ile görebilirsiniz. Moduller hakkındaki ayrıntılı bilgiye <a href="#id19"><span class="problematic" id="id20">:ref:`moduller-truba`</span></a> sayfasından erişim sağlayabilirsiniz.</p>
<div class="system-message" id="id19">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 444); <em><a href="#id20">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
<pre class="literal-block">
# Sistemde yüklü matlab versiyonlarını görmek için
module avail -t 2&gt;&amp;1 | grep -i matlab
</pre>
<img alt="/assets/matlab-howto/matlab1.png" src="/assets/matlab-howto/matlab1.png" style="width: 400px;" />
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>TRUBA üzerinde küme yönetimi ve iş zamanlayıcı olarak <a href="#id21"><span class="problematic" id="id22">:ref:`SLURM &lt;slurm-betik&gt;`</span></a> kullanılmaktadır. Kümede iş çalıştırmadan önce <a href="#id23"><span class="problematic" id="id24">:ref:`SLURM betik özellikleri &lt;slurm-betik&gt;`</span></a> hakkında bilgi edinmiş olmanız beklenmektedir. İş göndereceğiniz hesaplama kümeleri ile ilgili bilgiye <a href="#id25"><span class="problematic" id="id26">:ref:`hesaplama-kumeleri`</span></a> sayfasından erişebilirsiniz.</p>
<div class="system-message" id="id21">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 456); <em><a href="#id22">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
<div class="system-message" id="id23">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 456); <em><a href="#id24">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
<div class="last system-message" id="id25">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 456); <em><a href="#id26">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
</div>
<p>Lisans dosyanızı TRUBA arayüz sunucusuna transfer ediniz. Bunu terminal aracılığıyla <tt class="docutils literal">scp</tt> komutu ile yapabileceğiniz gibi <a href="#id27"><span class="problematic" id="id28">:ref:`winscp, filezilla &lt;ssh-baglanti&gt;`</span></a> vb. gibi SFTP yazılımları aracılğıyla da gerçekleştirebilirsiniz.</p>
<div class="system-message" id="id27">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">MATLAB_TRUBA.rst</tt>, line 458); <em><a href="#id28">backlink</a></em></p>
Unknown interpreted text role &quot;ref&quot;.</div>
<pre class="literal-block">
## username kısmını TRUBA kullanıcı adınızla değiştirmeyi unutmayin
scp -r &quot;lisans_dosyanızın_bilgisayarınızdaki_yeri&quot; username&#64;levrek1.ulakbim.gov.tr:/truba/home/username/
</pre>
<ul class="simple">
<li>Kullanacağınız MATLAB versiyonuna karar verdiyseniz</li>
<li>İş göndereceğiniz sunucuya karar verdiyseniz</li>
<li>SLURM betik dosyası hazırlamakla ilgili bilgi edindiyseniz</li>
<li>MATLAB lisans dosyanızı arayüz sunucusuna aktardıysanız</li>
</ul>
<p>örnek bir betik dosyasını <tt class="docutils literal">/truba/sw/scripts/matlab</tt> dizininin altında inceleyebilir ve işlerinizi kümeye gönderebilirsiniz.</p>
<pre class="literal-block">
### matlab.slurm dosyasinin icerigi

$MATLAB_DIR/bin/matlab -nodisplay -nosplash &lt; test.m &gt; OUTPUTFILE.out
exit

#!/bin/bash
#SBATCH -p hamsi #isi gondermek istediginiz kuyrugun adini yaziniz.
#SBATCH -A kullanici_kuyruk_hesabi #kendi kuyruk hesabinizi yaziniz.
#SBATCH -J matlab
#SBATCH -N 1
#SBATCH -n 1
#SBATCH --cpus-per-task 28
#SBATCH --time=1:00:00

echo &quot;SLURM_NODELIST $SLURM_NODELIST&quot;
echo &quot;NUMBER OF CORES $SLURM_NTASKS&quot;

#kendi lisans dosyanizin adi ve tam yolu..
export MLM_LICENSE_FILE=$HOME/matlab_license.lic

## onceden yuklu moduller varsa, kaldirin
module purge

#Cevre degiskenleri modul ile load edebilir
module load centos7.9/app/matlab/r2021b

## MATLAB R2018b versiyonu icin
## module load centos7.3/app/matlab/R2018b

#ya da kendiniz elle yapilandirabilirsiniz.
#MATLAB_DIR=/truba/sw/centos7.3/app/matlab/R2018b
#export LD_LIBRARY_PATH=$MATLAB_DIR/lib:$LD_LIBRARY_PATH
#export PATH=$MATLAB_DIR/bin:$PATH


## test.m dosyasini calistirmak istediginiz matlab dosyasi ile degistirin
$MATLAB_DIR/bin/matlab -nodisplay -nosplash &lt; test.m &gt; OUTPUTFILE.out

exit
</pre>
<pre class="literal-block">
##  test.m dosyasinin icerigi
A=rand(100,100);
B=rand(100,100);
C=A*B;
size(C);
quit
</pre>
<p><tt class="docutils literal">sbatch</tt> ile işinizi kuyruğa gönderebilirsiniz.</p>
<pre class="literal-block">
## isinizi kuyruga gondermek icin
sbatch name_of_your_slurm_file

## isinizin durumu hakkinda bilgi edinmek icin
squeue -u username

## isinizi iptal etmek isterseniz
scancel &quot;JOBID&quot;
</pre>
<p>Çalıştırmış olduğunuz dosya ile ilgili çıktı dosyaları (<tt class="docutils literal">OUTPUTFILE.out</tt>, <tt class="docutils literal"><span class="pre">slurm-&quot;jobid&quot;.err</span></tt>,  <tt class="docutils literal"><span class="pre">slurm-&quot;jobid&quot;.out</span></tt>)  işi göndermiş olduğunuz klasörde yer alacaktır. Ayrıca <tt class="docutils literal">.matlab</tt> klasörü altında da göndermiş olduğunuz işle ilgili detaylara da erişebilirsiniz.</p>
<p><tt class="docutils literal">batch</tt> ile işinizi gönderirken output dosyasını iki farklı şekilde yazdırabilirsiniz (dosyanızın adı &quot;INPUTFILE&quot;  olsun)</p>
<pre class="literal-block">
# Bu metot ile iş gönderdiğinizde çıktı dosyanız MATLAB tarafından oluşturulan &quot;&gt;&gt;&quot; karakterlerini içerecektir.
matlab -nodisplay -nosplash &lt; INPUTFILE.m &gt; OUTPUTFILE.out

# Bu metot ile çalıştırdığınızda betiğinizin sonunda (INPUTFILE) &quot;quit&quot; komutu yer almalıdır. Aksi takdirde MATLAB, calıştırmak için komut bekleyeceğinden hesaplama kaynaklarını boş yere meşgul edecektir.

matlab -nodisplay -nosplash -r INPUTFILE -logfile OUTPUTFILE.out
</pre>
</div>
<div class="section" id="ek-notlar">
<h1>Ek Notlar</h1>
<ul class="simple">
<li>Örnek betik dosyalarına <tt class="docutils literal">/truba/sw/scripts/matlab</tt> dizininden erişim sağlayabilirsiniz.</li>
</ul>
<p>Dökümanla ilgili eksik ya da hata bulmanız durumunda bizlere <a class="reference external" href="mailto:grid-teknik&#64;ulakbim.gov.tr">grid-teknik&#64;ulakbim.gov.tr</a> adresinden erişebilirsiniz. Eklenmesini istediğiniz bilgiler için de bizlere aynı adresten ulaşabilirsiniz.</p>
</div>
</div>
</body>
</html>
